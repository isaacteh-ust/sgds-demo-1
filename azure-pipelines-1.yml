# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger: none
    
pool:
  vmImage: 'ubuntu-18.04'

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.2 < 2.6'

- script: |
    gem install bundler
    bundle update jekyll
    bundle install --retry=3 --jobs=4
    jekyll build
  displayName: 'bundle install'
- task: DockerInstaller@0
  inputs:
    dockerVersion: '17.09.0-ce'
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      chmod -R 777 $(pwd)/_site
      ls -lrt
      echo "^ ls"
      ls -lrt "$(pwd)"
      echo "^ pwd ls"      
      ls -lrt "$(pwd)/_site"
      echo "^ pwd _site ls"
      docker run --rm --volume="/home/vsts/work/1/s/_site:/usr/local/apache2/htdocs" -p 8080:80 -dit httpd:2.4
      curl -v http://172.17.0.1:8080
- task: CopyFiles@2
  displayName: 'Copy _site to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: _site
    TargetFolder: $(Build.ArtifactStagingDirectory)
- task: CopyFiles@2
  displayName: 'Copy test script to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: test
    TargetFolder: $(Build.ArtifactStagingDirectory)    
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    ArtifactName: drop